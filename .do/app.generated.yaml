# DigitalOcean App Platform spec (Siddes backend)
# This file is safe to commit. Secrets are injected at deploy-time by scripts/deploy/do_upsert.sh
# Docs: https://docs.digitalocean.com/products/app-platform/reference/app-spec/

name: siddes-api
region: fra

alerts:
  - rule: DEPLOYMENT_FAILED
  - rule: DOMAIN_FAILED

# Add the custom domain now; DNS can be pointed later.
domains:
  - domain: api.siddes.com
    type: PRIMARY

# Managed databases (dev/prod). App Platform will provision these if cluster_name isn't provided.
databases:
  - engine: PG
    name: siddes-db
    version: "16"

services:
  - name: api
    environment_slug: python
    github:
      repo: cnyakundi/siddessocial.git
      branch: main
      deploy_on_push: true
    source_dir: /backend
    http_port: 8080
    instance_count: 1
    instance_size_slug: apps-s-1vcpu-1gb
    run_command: ./start_prod.sh

    envs:
      # Core
      - key: DJANGO_DEBUG
        scope: RUN_TIME
        value: "0"
      - key: DJANGO_SECRET_KEY
        scope: RUN_TIME
        type: SECRET
        value: "ed4a7fc495e8515da71da9261fb3251fda878b7e09d84b66c4c227b9d710530b"

      # Bindable database URLs
      - key: DATABASE_URL
        scope: RUN_TIME
        value: ${siddes-db.DATABASE_URL}

      # Host + CSRF
      - key: DJANGO_ALLOWED_HOSTS
        scope: RUN_TIME
        value: "api.siddes.com"
      - key: DJANGO_CSRF_TRUSTED
        scope: RUN_TIME
        value: "https://app.siddes.com"
      - key: SIDDES_PUBLIC_APP_BASE
        scope: RUN_TIME
        value: "https://app.siddes.com"

      # Contacts secret
      - key: SIDDES_CONTACTS_PEPPER
        scope: RUN_TIME
        type: SECRET
        value: "c33481b68842bb7f2959f0a8c968e3fa80b9d8740e386484ae26b4f13afa8219"

      # Email (set to console for first deploy; switch to smtp/sendgrid later)
      - key: SD_EMAIL_PROVIDER
        scope: RUN_TIME
        value: "console"
      - key: SD_EMAIL_FROM
        scope: RUN_TIME
        value: "no-reply@siddes.com"

      # Logging
      - key: SD_LOG_LEVEL
        scope: RUN_TIME
        value: "info"

      # Cloudflare R2 signing (uploads)
      - key: SIDDES_R2_BUCKET
        scope: RUN_TIME
        value: "siddes-media"
      - key: SIDDES_R2_ACCOUNT_ID
        scope: RUN_TIME
        value: "023c79daa84ce0cdeee53ad601180836"
      - key: SIDDES_R2_ACCESS_KEY_ID
        scope: RUN_TIME
        type: SECRET
        value: "PASTE_FROM_CLOUDFLARE_R2"
      - key: SIDDES_R2_SECRET_ACCESS_KEY
        scope: RUN_TIME
        type: SECRET
        value: "PASTE_FROM_CLOUDFLARE_R2"

      # Cloudflare Worker token gate (/m/*)
      - key: SIDDES_MEDIA_TOKEN_SECRET
        scope: RUN_TIME
        type: SECRET
        value: "PASTE_THE_SAME_VALUE_AS_WORKER_SECRET"

ingress:
  rules:
    - component:
        name: api
      match:
        path:
          prefix: /
